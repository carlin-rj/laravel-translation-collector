<?php

namespace Carlin\LaravelTranslationCollector\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Contracts\Filesystem\FileNotFoundException;
use Illuminate\Support\Facades\File;
use Carlin\LaravelTranslationCollector\Contracts\ExternalApiClientInterface;

class SyncTranslationsCommand extends Command
{
    /**
     * ÂëΩ‰ª§Á≠æÂêç
     *
     * @var string
     */
    protected $signature = 'translation:sync
                            {--language=* : ÊåáÂÆöÂêåÊ≠•ÁöÑËØ≠Ë®Ä}
                            {--merge-mode=merge : ÂÜÖÂÆπÂêàÂπ∂Ê®°Âºè (merge, overwrite)}
                            {--dry-run : ‰ªÖÊòæÁ§∫Â∑ÆÂºÇÔºå‰∏çÂÆûÈôÖÂêåÊ≠•}
                            {--force : Âº∫Âà∂Ë¶ÜÁõñÊú¨Âú∞Êñá‰ª∂}
                            {--auto-detect-format : Ëá™Âä®Ê£ÄÊµãÊñá‰ª∂Ê†ºÂºèÊ†πÊçÆÂ§ñÈÉ®Á≥ªÁªüËøîÂõûÁöÑfile_type}';

    /**
     * ÂëΩ‰ª§ÊèèËø∞
     *
     * @var string
     */
    protected $description = '‰∏éÂ§ñÈÉ®ÁøªËØëÁ≥ªÁªüÂêåÊ≠•ÁøªËØëÊñá‰ª∂ÔºåÊîØÊåÅÊô∫ËÉΩÊ†ºÂºèÊ£ÄÊµãÂíåÂÜÖÂÆπÂêàÂπ∂';

    /**
     * Â§ñÈÉ®APIÂÆ¢Êà∑Á´Ø
     *
     * @var ExternalApiClientInterface
     */
    protected ExternalApiClientInterface $apiClient;

    /**
     * ÈÖçÁΩÆ
     *
     * @var array
     */
    protected array $config;

    /**
     * ÊûÑÈÄ†ÂáΩÊï∞
     *
     * @param ExternalApiClientInterface $apiClient
     */
    public function __construct(ExternalApiClientInterface $apiClient)
    {
        parent::__construct();
        $this->apiClient = $apiClient;
        $this->config = config('translation-collector');
    }

    /**
     * ÊâßË°åÂëΩ‰ª§
     *
     * @return int
     */
    public function handle(): int
    {
        $this->info('üîÑ ÂºÄÂßãÂêåÊ≠•ÁøªËØëÊñá‰ª∂...');

        try {
            // Ê£ÄÊü•APIËøûÊé•
            if (!$this->apiClient->checkConnection()) {
                $this->error('‚ùå Êó†Ê≥ïËøûÊé•Âà∞Â§ñÈÉ®ÁøªËØëÁ≥ªÁªü');
                return 1;
            }

            $languages = $this->option('language') ?: array_keys($this->config['supported_languages']);

            // ÊòæÁ§∫ÈÖçÁΩÆ‰ø°ÊÅØ
            $this->displaySyncConfiguration($languages);

			$this->pullFromExternal($languages);

            $this->info('‚úÖ ÁøªËØëÂêåÊ≠•ÂÆåÊàê!');
            return 0;

        } catch (\Exception $e) {
            $this->error("‚ùå ÁøªËØëÂêåÊ≠•Â§±Ë¥•: {$e->getMessage()}");
            return 1;
        }
    }

    /**
     * ÊòæÁ§∫ÂêåÊ≠•ÈÖçÁΩÆ‰ø°ÊÅØ
     *
     * @param array $languages
     */
    protected function displaySyncConfiguration(array $languages): void
    {
        $this->info('üìä ÂêåÊ≠•ÈÖçÁΩÆ:');
        $this->table(
            ['È°πÁõÆ', 'ÂÄº'],
            [
                ['ÁõÆÊ†áËØ≠Ë®Ä', implode(', ', $languages)],
                ['ÂêàÂπ∂Ê®°Âºè', $this->option('merge-mode')],
                ['Ëá™Âä®Ê£ÄÊµãÊ†ºÂºè', $this->option('auto-detect-format') ? 'ÊòØ' : 'Âê¶'],
                ['‰πæË∑ëÊ®°Âºè', $this->option('dry-run') ? 'ÊòØ' : 'Âê¶'],
            ]
        );
        $this->newLine();
    }

    /**
     * ‰ªéÂ§ñÈÉ®Á≥ªÁªüÊãâÂèñÁøªËØë
     *
     * @param array $languages
     */
    protected function pullFromExternal(array $languages): void
    {
        $this->info('üì• ‰ªéÂ§ñÈÉ®Á≥ªÁªüÊãâÂèñÁøªËØë...');

        foreach ($languages as $language) {
            $this->line("Â§ÑÁêÜËØ≠Ë®Ä: {$language}");

            try {
                // Ëé∑ÂèñÂ§ñÈÉ®ÁøªËØë
                $externalTranslations = $this->apiClient->getTranslations([
                    'language' => $language
                ]);

                if (empty($externalTranslations)) {
                    $this->warn("  - Ê≤°ÊúâÊâæÂà∞ {$language} ÁöÑÁøªËØë");
                    continue;
                }

                // ÊåâÊñá‰ª∂ÁõÆÊ†áÂàÜÁªÑÔºåÂπ∂È¢ÑÂ§ÑÁêÜÊâÄÊúâÊñá‰ª∂‰ø°ÊÅØ
                $groupedTranslations = $this->groupTranslationsByFileTarget($externalTranslations, $language);

                $totalProcessed = 0;
                $savedFormats = [];

                // Â§ÑÁêÜÊØè‰∏™Êñá‰ª∂ÁªÑ
                foreach ($groupedTranslations as $fileGroup) {
                    $processedCount = $this->processFileGroup($fileGroup);

                    if ($processedCount > 0) {
                        $totalProcessed += $processedCount;
                        $savedFormats[] = $fileGroup['fileInfo']['type'];
                    }
                }

                if ($totalProcessed > 0) {
                    $formatStr = implode('+', array_unique($savedFormats));
                    $this->info("  - ‚úÖ Â∑≤Êõ¥Êñ∞ {$language} ({$totalProcessed} È°π, Ê†ºÂºè: {$formatStr})");
                } else {
                    $this->warn("  - ‚ö†Ô∏è {$language} Ê≤°ÊúâÊúâÊïàÁöÑÁøªËØëÊï∞ÊçÆ");
                }

            } catch (\Exception $e) {
                $this->error("  - ‚ùå {$language} ÂêåÊ≠•Â§±Ë¥•: " . $e->getMessage());
            }
        }
    }

    /**
     * ÊåâÊñá‰ª∂ÁõÆÊ†áÂàÜÁªÑÂ§ñÈÉ®ÁøªËØëÊï∞ÊçÆÔºåÂπ∂È¢ÑÂ§ÑÁêÜÊñá‰ª∂‰ø°ÊÅØ
     *
     * @param array $externalTranslations
     * @param string $language
     * @return array
     */
    protected function groupTranslationsByFileTarget(array $externalTranslations, string $language): array
    {
        $grouped = [];
        $validTranslations = 0;
        $invalidTranslations = 0;
        $langPath = $this->config['lang_path'];

        foreach ($externalTranslations as $translation) {
            // È™åËØÅÁøªËØëÊï∞ÊçÆÊ†ºÂºè
            if (!$this->validateTranslationData($translation)) {
                $invalidTranslations++;
                $this->warn("Ë∑≥ËøáÊó†ÊïàÁöÑÁøªËØëÊï∞ÊçÆ: " . json_encode($translation));
                continue;
            }

            // Á°ÆÂÆöÊñá‰ª∂Á±ªÂûãÂíåÁõÆÊ†áË∑ØÂæÑ
			$fileInfo = $this->buildFileInfo($translation, $language, $langPath);
			// È¢ÑÂ§ÑÁêÜÊñá‰ª∂‰ø°ÊÅØ
            if (!isset($grouped[$fileInfo['path']])) {
                $grouped[$fileInfo['path']] = [
					'fileInfo'     => $fileInfo,
					'translations' => []
                ];
            }
            $grouped[$fileInfo['path']]['translations'][] = $translation;
            $validTranslations++;
        }

        // ËæìÂá∫Â§ÑÁêÜÁªüËÆ°
        if ($invalidTranslations > 0) {
            $this->warn("Ë∑≥Ëøá‰∫Ü {$invalidTranslations} Êù°Êó†ÊïàÁøªËØëÊï∞ÊçÆ");
        }

        if ($validTranslations > 0) {
            $fileTargets = array_keys($grouped);
            $this->info("ÊúâÊïàÁøªËØëÊï∞ÊçÆ: {$validTranslations} Êù°ÔºåÊñá‰ª∂ÁõÆÊ†á: " . implode(', ', $fileTargets));
        }

        return $grouped;
    }

    /**
     * Ëé∑ÂèñÁøªËØëÊñá‰ª∂Á±ªÂûã
     *
     * @param array $translation
     * @return string
     */
    protected function getTranslationFileType(array $translation): string
    {
        // ÈªòËÆ§‰ΩøÁî® JSON Ê†ºÂºè
        $fileType = 'json';

        if (isset($translation['file_type'])) {
            $detectedType = strtolower(trim($translation['file_type']));
            if (in_array($detectedType, ['php', 'json'])) {
                $fileType = $detectedType;
            }
        }
        return $fileType;
    }

    /**
     * ÊûÑÂª∫Êñá‰ª∂‰ø°ÊÅØ
     *
     * @param array $translation
     * @param string $language
     * @param string $langPath
     * @return array
     */
    protected function buildFileInfo(array $translation, string $language, string $langPath): array
    {
		$fileType = $this->getTranslationFileType($translation);


		if ($fileType === 'json') {
            return [
                'type' => 'json',
                'language' => $language,
                'path' => "{$langPath}/{$language}.json",
                'directory' => $langPath,
                'fileName' => "{$language}.json"
            ];
        } else {
            $fileName = $this->extractFileNameFromKey($translation['key']);
            $directory = "{$langPath}/{$language}";
            return [
                'type' => 'php',
                'language' => $language,
                'fileName' => $fileName,
                'path' => "{$directory}/{$fileName}.php",
                'directory' => $directory
            ];
        }
    }

    /**
     * ‰ªéÁøªËØëÈîÆ‰∏≠ÊèêÂèñÊñá‰ª∂Âêç
     *
     * @param string $key
     * @return string|null
     */
    protected function extractFileNameFromKey(string $key): ?string
    {
        if (str_contains($key, '.')) {
            return explode('.', $key, 2)[0];
        }
        return null; // ÈªòËÆ§Êñá‰ª∂Âêç
    }

    /**
     * Â§ÑÁêÜÊñá‰ª∂ÁªÑ
     *
     * @param array $fileGroup
     * @return int Â§ÑÁêÜÁöÑÁøªËØëÊï∞Èáè
     */
    protected function processFileGroup(array $fileGroup): int
    {
        $fileInfo = $fileGroup['fileInfo'];
        $translations = $fileGroup['translations'];

        if (empty($translations)) {
            return 0;
        }

        // Á°Æ‰øùÁõÆÂΩïÂ≠òÂú®
        $this->ensureDirectoryExists($fileInfo['directory']);

        // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÂ§ÑÁêÜ
        if ($fileInfo['type'] === 'json') {
            return $this->processJsonFileGroup($fileInfo, $translations);
        } else {
            return $this->processPhpFileGroup($fileInfo, $translations);
        }
    }

	/**
	 * Â§ÑÁêÜ JSON Êñá‰ª∂ÁªÑ
	 *
	 * @param array $fileInfo
	 * @param array $translations
	 * @return int
	 * @throws FileNotFoundException
	 * @throws \JsonException
	 */
    protected function processJsonFileGroup(array $fileInfo, array $translations): int
    {
        // Âä†ËΩΩÁé∞ÊúâÁöÑ JSON ÁøªËØë
        $localTranslations = $this->loadJsonTranslations($fileInfo['path']);

        // Ê†ºÂºèÂåñÂ§ñÈÉ®ÁøªËØë
        $externalFormatted = $this->formatTranslationsForLocal($translations);

        // ÂêàÂπ∂ÁøªËØë
        $finalTranslations = $this->mergeTranslations($localTranslations, $externalFormatted);

        // ‰øùÂ≠òÊñá‰ª∂
        $this->saveJsonFile($fileInfo['path'], $finalTranslations);

        return count($finalTranslations);
    }

    /**
     * Â§ÑÁêÜ PHP Êñá‰ª∂ÁªÑ
     *
     * @param array $fileInfo
     * @param array $translations
     * @return int
     */
    protected function processPhpFileGroup(array $fileInfo, array $translations): int
    {
        // Âä†ËΩΩÁé∞ÊúâÁöÑ PHP ÁøªËØëÔºàÊåâÊñá‰ª∂ÂêçËøáÊª§Ôºâ
        $localTranslations = $this->loadPhpTranslationsByFile($fileInfo['path'], $fileInfo['fileName']);

        // Ê†ºÂºèÂåñÂ§ñÈÉ®ÁøªËØë
        $externalFormatted = $this->formatTranslationsForLocal($translations);

        // ÂêàÂπ∂ÁøªËØë
        $finalTranslations = $this->mergeTranslations($localTranslations, $externalFormatted);

        // ‰øùÂ≠òÊñá‰ª∂
        $this->savePhpFile($fileInfo['path'], $finalTranslations, $fileInfo['fileName']);

        return count($finalTranslations);
    }

    /**
     * Á°Æ‰øùÁõÆÂΩïÂ≠òÂú®
     *
     * @param string $directory
     */
    protected function ensureDirectoryExists(string $directory): void
    {
        if (!File::exists($directory)) {
            File::makeDirectory($directory, 0755, true);
        }
    }

    /**
     * ‰øùÂ≠ò JSON Êñá‰ª∂
     *
     * @param string $filePath
     * @param array $translations
     */
    protected function saveJsonFile(string $filePath, array $translations): void
    {
        $content = json_encode($translations, JSON_THROW_ON_ERROR | JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);

        // Ê£ÄÊü•ÊòØÂê¶Âº∫Âà∂Ë¶ÜÁõñ
        if (File::exists($filePath) && !$this->option('force') && !$this->option('dry-run')) {
            if (!$this->confirm("Êñá‰ª∂ {$filePath} Â∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÜÁõñÔºü")) {
                return;
            }
        }

        if (!$this->option('dry-run')) {
            File::put($filePath, $content);
            $this->line("    ‚Üí Â∑≤‰øùÂ≠òÂà∞: {$filePath}");
        } else {
            $this->line("    ‚Üí [Âπ≤Ë∑ë] Â∞Ü‰øùÂ≠òÂà∞: {$filePath}");
        }
    }

    /**
     * ‰øùÂ≠ò PHP Êñá‰ª∂
     *
     * @param string $filePath
     * @param array $translations
     * @param string $fileName
     */
    protected function savePhpFile(string $filePath, array $translations, string $fileName): void
    {
        // Â∞ÜÂπ≥Âù¶ÁöÑÈîÆËΩ¨Êç¢‰∏∫ÂµåÂ•óÊï∞ÁªÑ
        $nestedTranslations = $this->unflattenArrayForFile($translations, $fileName);
        $content = "<?php\n\nreturn " . var_export($nestedTranslations, true) . ";\n";

        // Ê£ÄÊü•ÊòØÂê¶Âº∫Âà∂Ë¶ÜÁõñ
        if (File::exists($filePath) && !$this->option('force') && !$this->option('dry-run')) {
            if (!$this->confirm("Êñá‰ª∂ {$filePath} Â∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÜÁõñÔºü")) {
                return;
            }
        }

        if (!$this->option('dry-run')) {
            File::put($filePath, $content);
            $this->line("    ‚Üí Â∑≤‰øùÂ≠òÂà∞: {$filePath}");
        } else {
            $this->line("    ‚Üí [Âπ≤Ë∑ë] Â∞Ü‰øùÂ≠òÂà∞: {$filePath}");
        }
    }

	/**
	 * ÊåâÊñá‰ª∂ÂêçÂä†ËΩΩ PHP ÁøªËØë
	 *
	 * @param string $filePath
	 * @return array
	 */
    protected function loadPhpTranslationsByFile(string $filePath, string $fileName): array
    {
        if (File::exists($filePath)) {
            try {
                $fileData = include $filePath;
                if (is_array($fileData)) {
                    // ‰∏∫ PHP Êñá‰ª∂‰∏≠ÁöÑÈîÆÂä†‰∏äÊñá‰ª∂ÂêçÂâçÁºÄÔºåÊâÅÂπ≥ÂåñÂ§ÑÁêÜ
                    return $this->flattenArray($fileData, $fileName);
                }
            } catch (\Exception $e) {
                $this->warn("Êó†Ê≥ïÂä†ËΩΩÊñá‰ª∂ {$filePath}: {$e->getMessage()}");
            }
        }

        return [];
    }

    /**
     * È™åËØÅÂ§ñÈÉ®ÁøªËØëÊï∞ÊçÆÊ†ºÂºè
     *
     * @param array $translation
     * @return bool
     */
    protected function validateTranslationData(array $translation): bool
    {
        // ÂøÖÈ°ªÂåÖÂê´ key Âíå value Â≠óÊÆµ
        if (!isset($translation['key'], $translation['value'])) {
            return false;
        }

        // key Âíå value ‰∏çËÉΩ‰∏∫Á©∫
        if (empty(trim($translation['key'])) || empty(trim($translation['value']))) {
            return false;
        }

        // Â¶ÇÊûúÊúâ file_type Â≠óÊÆµÔºåÈ™åËØÅÂÖ∂ÂÄºÊòØÂê¶ÊúâÊïà
        if (isset($translation['file_type'])) {
            $fileType = strtolower(trim($translation['file_type']));
            if (!in_array($fileType, ['php', 'json', ''])) {
                return false;
            }
        }

		//phpÔºå‰ΩÜÊòØkeyËßÑÂàô‰∏çÂØπ
		if ($translation['file_type'] === 'php' && !$this->extractFileNameFromKey($translation['key'])) {
			return false;
		}

        return true;
    }

    /**
     * ÂêàÂπ∂ÁøªËØëÂÜÖÂÆπ
     *
     * @param array $localTranslations
     * @param array $externalTranslations
     * @return array
     */
    protected function mergeTranslations(array $localTranslations, array $externalTranslations): array
    {
        $mergeMode = $this->option('merge-mode');

        if ($mergeMode === 'overwrite') {
			return $externalTranslations;
        }

        // ÂêàÂπ∂Ê®°ÂºèÔºàÈªòËÆ§Ôºâ
		return array_merge($localTranslations, $externalTranslations);
	}

    /**
     * ÊåâÊñá‰ª∂ÂêçÂàÜÁªÑÁøªËØë
     * ‰æãÂ¶Ç: 'auth.login' -> ÂΩíÁ±ªÂà∞ 'auth' Êñá‰ª∂
     *       'validation.required' -> ÂΩíÁ±ªÂà∞ 'validation' Êñá‰ª∂
     *       'simple_key' -> ÂΩíÁ±ªÂà∞ 'messages' Êñá‰ª∂ÔºàÈªòËÆ§Ôºâ
     *
     * @param array $translations
     * @return array
     */
    protected function groupTranslationsByFile(array $translations): array
    {
        $grouped = [];

        foreach ($translations as $key => $value) {
            // Ê£ÄÊü•ÈîÆÊòØÂê¶ÂåÖÂê´ÁÇπÂè∑ÔºàÂëΩÂêçÁ©∫Èó¥ÂàÜÈöîÁ¨¶Ôºâ
            if (str_contains($key, '.')) {
                // Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™ÁÇπÂè∑‰πãÂâçÁöÑÈÉ®ÂàÜ‰Ωú‰∏∫Êñá‰ª∂Âêç
                $fileName = explode('.', $key, 2)[0];
            } else {
                // Ê≤°ÊúâÂëΩÂêçÁ©∫Èó¥ÁöÑÈîÆÂΩíÁ±ªÂà∞ messages Êñá‰ª∂
                $fileName = 'messages';
            }

            if (!isset($grouped[$fileName])) {
                $grouped[$fileName] = [];
            }

            $grouped[$fileName][$key] = $value;
        }

        return $grouped;
    }

    /**
     * ‰∏∫ÁâπÂÆöÊñá‰ª∂Â∞ÜÂπ≥Âù¶ÁöÑÈîÆËΩ¨Êç¢‰∏∫ÂµåÂ•óÊï∞ÁªÑ
     * ÁßªÈô§Êñá‰ª∂ÂêçÂâçÁºÄ
     *
     * @param array $translations
     * @param string $fileName
     * @return array
     */
    protected function unflattenArrayForFile(array $translations, string $fileName): array
    {
        $result = [];

        foreach ($translations as $key => $value) {
            // Â¶ÇÊûúÈîÆ‰ª•Êñá‰ª∂ÂêçÂºÄÂ§¥ÔºåÁßªÈô§Êñá‰ª∂ÂêçÂâçÁºÄ
            if (str_starts_with($key, $fileName . '.')) {
                $cleanKey = substr($key, strlen($fileName) + 1);
            } else {
                // Ê≤°ÊúâÂâçÁºÄÁöÑÈîÆÔºàÂ¶ÇÂΩíÁ±ªÂà∞messagesÁöÑÁÆÄÂçïÈîÆÔºâ
                $cleanKey = $key;
            }

            // Â∞ÜÊ∏ÖÁêÜÂêéÁöÑÈîÆËΩ¨Êç¢‰∏∫ÂµåÂ•óÁªìÊûÑ
            $keys = explode('.', $cleanKey);
            $temp = &$result;

            foreach ($keys as $k) {
                if (!isset($temp[$k])) {
                    $temp[$k] = [];
                }
                $temp = &$temp[$k];
            }

            $temp = $value;
        }

        return $result;
    }

    /**
     * Â∞ÜÂπ≥ÂùÇÁöÑÈîÆËΩ¨Êç¢‰∏∫ÂµåÂ•óÊï∞ÁªÑ
     *
     * @param array $flatArray
     * @param string $separator
     * @return array
     */
    protected function unflattenArray(array $flatArray, string $separator = '.'): array
    {
        $result = [];

        foreach ($flatArray as $key => $value) {
            $keys = explode($separator, $key);
            $temp = &$result;

            foreach ($keys as $k) {
                if (!isset($temp[$k])) {
                    $temp[$k] = [];
                }
                $temp = &$temp[$k];
            }

            $temp = $value;
        }

        return $result;
    }

	/**
	 * Âä†ËΩΩJSONÊ†ºÂºèÁøªËØëÊñá‰ª∂
	 *
	 * @param string $fileName
	 * @return array
	 * @throws FileNotFoundException
	 */
    protected function loadJsonTranslations(string $fileName): array
    {
        if (File::exists($fileName)) {
            $content = File::get($fileName);
            return json_decode($content, true) ?: [];
        }
        return [];
    }

    /**
     * Âä†ËΩΩPHPÊ†ºÂºèÁøªËØëÊñá‰ª∂ÔºàÂ§öÊñá‰ª∂Ôºâ
     *
     * @param string $language
     * @param string $langPath
     * @return array
     */
    protected function loadPhpTranslations(string $language, string $langPath): array
    {
        $languageDir = "{$langPath}/{$language}";
        $allData = [];

        if (File::exists($languageDir) && File::isDirectory($languageDir)) {
            $phpFiles = File::glob("{$languageDir}/*.php");

            foreach ($phpFiles as $phpFile) {
                try {
                    $fileData = include $phpFile;
                    if (is_array($fileData)) {
                        $fileName = pathinfo($phpFile, PATHINFO_FILENAME);
                        // ‰∏∫PHPÊñá‰ª∂‰∏≠ÁöÑÈîÆÂä†‰∏äÊñá‰ª∂ÂêçÂâçÁºÄÔºåÊâÅÂπ≥ÂåñÂ§ÑÁêÜ
                        $flatData = $this->flattenArray($fileData, $fileName);
                        $allData = array_merge($allData, $flatData);
                    }
                } catch (\Exception $e) {
                    // ÂøΩÁï•Êó†Ê≥ïÂä†ËΩΩÁöÑÊñá‰ª∂
                    $this->warn("Êó†Ê≥ïÂä†ËΩΩÊñá‰ª∂ {$phpFile}: {$e->getMessage()}");
                }
            }
        }

        return $allData;
    }

    /**
     * Â∏¶ÂâçÁºÄÊâÅÂπ≥ÂåñÊï∞ÁªÑ
     * ‰æãÂ¶ÇÔºöfileName = 'auth', array = ['login' => 'Login']
     * ÁªìÊûúÔºö['auth.login' => 'Login']
     *
     * @param array $array
     * @param string $prefix
     * @param string $separator
     * @return array
     */
    protected function flattenArray(array $array, string $prefix, string $separator = '.'): array
    {
        $result = [];

        foreach ($array as $key => $value) {
            $newKey = $prefix . $separator . $key;

            if (is_array($value)) {
                $result = array_merge($result, $this->flattenArray($value, $newKey, $separator));
            } else {
                $result[$newKey] = $value;
            }
        }

        return $result;
    }

    /**
     * ÂàÜÊûêÂ∑ÆÂºÇ
     *
     * @param array $local
     * @param array $external
     * @return array
     */
    protected function analyzeDifferences(array $local, array $external): array
    {
        $localKeys = array_keys($local);
        $externalKeys = array_keys($external);

        return [
            'local_only' => array_diff($localKeys, $externalKeys),
            'external_only' => array_diff($externalKeys, $localKeys),
            'different_values' => $this->findDifferentValues($local, $external),
            'common' => array_intersect($localKeys, $externalKeys),
        ];
    }

    /**
     * Êü•ÊâæÂÄº‰∏çÂêåÁöÑÈîÆ
     *
     * @param array $local
     * @param array $external
     * @return array
     */
    protected function findDifferentValues(array $local, array $external): array
    {
        $different = [];

        foreach ($local as $key => $value) {
            if (isset($external[$key]) && $external[$key] !== $value) {
                $different[] = $key;
            }
        }

        return $different;
    }

    /**
     * ÊòæÁ§∫Â∑ÆÂºÇ
     *
     * @param string $language
     * @param array $differences
     */
    protected function displayDifferences(string $language, array $differences): void
    {
        $this->line("  - üìä {$language} Â∑ÆÂºÇÂàÜÊûê:");
        $this->line("    - ‰ªÖÊú¨Âú∞Â≠òÂú®: " . count($differences['local_only']));
        $this->line("    - ‰ªÖÂ§ñÈÉ®Â≠òÂú®: " . count($differences['external_only']));
        $this->line("    - ÂÄº‰∏çÂêå: " . count($differences['different_values']));
        $this->line("    - Áõ∏Âêå: " . count($differences['common']));
    }

    /**
     * Ê†ºÂºèÂåñÁøªËØëÊï∞ÊçÆ‰∏∫APIÊ†ºÂºè
     *
     * @param array $translations
     * @param string $language
     * @return array
     */
    protected function formatTranslationsForApi(array $translations, string $language): array
    {
        $formatted = [];

        foreach ($translations as $key => $value) {
            $formatted[] = [
                'key' => $key,
                'language' => $language,
                'value' => $value,
                'updated_at' => now()->toISOString(),
            ];
        }

        return $formatted;
    }

    /**
     * Ê†ºÂºèÂåñÁøªËØëÊï∞ÊçÆ‰∏∫Êú¨Âú∞Ê†ºÂºè
     *
     * @param array $translations
     * @return array
     */
    protected function formatTranslationsForLocal(array $translations): array
    {
        $formatted = [];

        foreach ($translations as $translation) {
            $key = $translation['key'] ?? '';
            $value = $translation['value'] ?? '';

            if ($key && $value) {
                $formatted[$key] = $value;
            }
        }

        return $formatted;
    }

}
